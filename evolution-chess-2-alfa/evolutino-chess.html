<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç—ã —Å –≠–≤–æ–ª—é—Ü–∏–µ–π V2</title>
    <style>
        :root {
            --bg-color: #2c3e50;
            --board-dark: #7f8c8d;
            --board-light: #ecf0f1;
            --highlight: rgba(241, 196, 15, 0.6);
            --capture: rgba(231, 76, 60, 0.6);
            --white-piece: #fff;
            --black-piece: #000;
            --white-stroke: #000;
            --black-stroke: #fff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 { margin-bottom: 5px; }
        .subtitle { color: #bdc3c7; margin-bottom: 20px; font-size: 0.9em; }

        .game-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Chess Board */
        #board {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            border: 5px solid #34495e;
            user-select: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .cell {
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 38px;
            cursor: pointer;
            position: relative;
        }

        .cell.light { background-color: var(--board-light); }
        .cell.dark { background-color: var(--board-dark); }
        .cell.selected { background-color: var(--highlight) !important; }
        .cell.possible-move::after {
            content: '';
            width: 14px;
            height: 14px;
            background: rgba(0,0,0,0.25);
            border-radius: 50%;
        }
        .cell.capture { background-color: var(--capture) !important; }

        /* Pieces */
        .piece {
            cursor: grab;
            transition: transform 0.2s;
            z-index: 2;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%; height: 100%;
        }
        .piece.white { color: var(--white-piece); text-shadow: 0 0 2px var(--white-stroke); }
        .piece.black { color: var(--black-piece); text-shadow: 0 0 2px var(--black-stroke); }
        
        /* Tiers Effects */
        .piece.tier-2 { filter: drop-shadow(0 0 3px #3498db); }
        .piece.tier-3 { filter: drop-shadow(0 0 5px #f1c40f); font-size: 44px; }

        /* Level badges */
        .lvl-badge {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 10px;
            background: rgba(0,0,0,0.8);
            color: #f1c40f;
            padding: 1px 4px;
            border-radius: 4px;
            pointer-events: none;
            font-weight: bold;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
        }

        .panel {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .turn-indicator {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .log {
            height: 200px;
            overflow-y: auto;
            font-size: 0.85em;
            font-family: monospace;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 5px;
            display: flex;
            flex-direction: column-reverse; /* Newest at bottom visually but scrolled */
        }

        /* Evolution Modal */
        #evolution-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            border: 4px solid #f1c40f;
        }

        .evo-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .evo-card {
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            width: 140px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .evo-card:hover {
            background: #fffdf0;
            transform: translateY(-5px);
            border-color: #f1c40f;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .evo-card.tier-3-card { border-color: #f1c40f; background: #fffbe6; }

        .evo-icon { font-size: 45px; display: block; margin-bottom: 10px; }
        .evo-name { font-weight: bold; display: block; margin-bottom: 5px; font-size: 1.1em;}
        .evo-desc { font-size: 0.8em; color: #555; line-height: 1.2; }
        .evo-tier { 
            position: absolute; top:0; right:0; 
            background: #f1c40f; color: #000; 
            font-size: 10px; padding: 2px 5px; font-weight: bold;
        }

        button.reset-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <h1>–®–∞—Ö–º–∞—Ç—ã: –≠–≤–æ–ª—é—Ü–∏—è –§–∏–≥—É—Ä V2</h1>
    <div class="subtitle">–í—Ç–æ—Ä–æ–π —Å–ª–æ–π —ç–≤–æ–ª—é—Ü–∏–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!</div>

    <div class="game-container">
        <div id="board"></div>

        <div class="sidebar">
            <div class="panel">
                <div class="turn-indicator" id="turn-display">–•–æ–¥: –ë–µ–ª—ã–µ</div>
                <div id="piece-info">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–≥—É—Ä—É...</div>
            </div>
            <div class="panel">
                <h3>–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h3>
                <div class="log" id="game-log"></div>
            </div>
            <button class="reset-btn" onclick="initGame()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>
    </div>

    <!-- Evolution Modal -->
    <div id="evolution-modal">
        <div class="modal-content">
            <h2 id="evo-title">–≠–≤–æ–ª—é—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞!</h2>
            <p>–í–∞—à–∞ —Ñ–∏–≥—É—Ä–∞ –Ω–∞–∫–æ–ø–∏–ª–∞ –æ–ø—ã—Ç –∏ –≥–æ—Ç–æ–≤–∞ –º—É—Ç–∏—Ä–æ–≤–∞—Ç—å.</p>
            <div class="evo-options" id="evo-container"></div>
        </div>
    </div>

<script>
/**
 * –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
 */
const BOARD_SIZE = 8;

// –°–∏–º–≤–æ–ª—ã –∏ –≠–º–æ–¥–∑–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞–¥–∏–π
const SYMBOLS = {
    // Basic
    pawn: '‚ôü', knight: '‚ôû', bishop: '‚ôù', rook: '‚ôú', queen: '‚ôõ', king: '‚ôö',
    // Tier 2
    spearman: 'üî±', soldier: '‚öî', 
    camel: 'üê´', paladin: 'üõ°', 
    bomber: 'üí£', ghost: 'üëª',
    tank: 'üöú',
    // Tier 3 (Legendary)
    spartan: 'üèõ', super_soldier: 'ü¶æ',
    camel_knight: 'üëπ', crusader: '‚öú',
    nuke_bishop: '‚ò¢', sniper: 'üî≠',
    fortress: 'üè∞' 
};

// === –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ë–ê–ó–û–í–´–• –•–û–î–û–í (–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã) ===
// –í—ã–Ω–æ—Å–∏–º –∏—Ö —Å—é–¥–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (TDZ)
const MOVES_ROOK = [{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}];
const MOVES_BISHOP = [{dx:1,dy:1},{dx:1,dy:-1},{dx:-1,dy:1},{dx:-1,dy:-1}];
const MOVES_KNIGHT = [{dx:2,dy:1},{dx:2,dy:-1},{dx:-2,dy:1},{dx:-2,dy:-1},{dx:1,dy:2},{dx:1,dy:-2},{dx:-1,dy:2},{dx:-1,dy:-2}];
const MOVES_KING_DIRS = [{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1},{dx:1,dy:1},{dx:1,dy:-1},{dx:-1,dy:1},{dx:-1,dy:-1}];
const MOVES_QUEEN = [...MOVES_ROOK, ...MOVES_BISHOP];
const MOVES_CAMEL = [{dx:3,dy:1},{dx:3,dy:-1},{dx:-3,dy:1},{dx:-3,dy:-1},{dx:1,dy:3},{dx:1,dy:-3},{dx:-1,dy:3},{dx:-1,dy:-3}];

// –§—É–Ω–∫—Ü–∏—è —Ö–µ–ª–ø–µ—Ä –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ö–æ–¥–æ–≤ (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –æ–±—ä–µ–∫—Ç–µ)
function getCombinedMoves(types) {
    let moves = [];
    types.forEach(t => {
        if (t === 'king') moves.push(...MOVES_KING_DIRS);
        if (t === 'rook') moves.push(...MOVES_ROOK);
        if (t === 'bishop') moves.push(...MOVES_BISHOP);
        if (t === 'knight') moves.push(...MOVES_KNIGHT);
        if (t === 'queen') moves.push(...MOVES_QUEEN);
    });
    return moves;
}

/**
 * –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –¢–ò–ü–û–í
 * tier: 1 (base), 2 (advanced), 3 (legendary)
 * xpReq: —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ XP –¥–ª—è —ç–≤–æ–ª—é—Ü–∏–∏ –∏–∑ –≠–¢–û–ô —Ñ–æ—Ä–º—ã
 */
const PIECE_TYPES = {
    // === TIER 1 (XP REQ: 1) ===
    'pawn': { name: '–ü–µ—à–∫–∞', symbol: SYMBOLS.pawn, role: 'pawn', tier: 1, xpReq: 1 },
    'rook': { name: '–õ–∞–¥—å—è', symbol: SYMBOLS.rook, moves: MOVES_ROOK, mode: 'slide', tier: 1, xpReq: 1 },
    'knight': { name: '–ö–æ–Ω—å', symbol: SYMBOLS.knight, moves: MOVES_KNIGHT, mode: 'leap', tier: 1, xpReq: 1 },
    'bishop': { name: '–°–ª–æ–Ω', symbol: SYMBOLS.bishop, moves: MOVES_BISHOP, mode: 'slide', tier: 1, xpReq: 1 },
    'queen': { name: '–§–µ—Ä–∑—å', symbol: SYMBOLS.queen, moves: MOVES_QUEEN, mode: 'slide', tier: 1, xpReq: 2 },
    'king': { name: '–ö–æ—Ä–æ–ª—å', symbol: SYMBOLS.king, moves: MOVES_KING_DIRS, mode: 'step', tier: 1, xpReq: 999 },

    // === TIER 2 (XP REQ: 2) ===
    
    // –í–µ—Ç–∫–∞ –ü–µ—à–∫–∏
    'pawn_soldier': {
        name: '–°–æ–ª–¥–∞—Ç', symbol: SYMBOLS.soldier, tier: 2, xpReq: 2,
        desc: '–•–æ–¥–∏—Ç –≤–ø–µ—Ä–µ–¥ –∏ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏',
        role: 'pawn', extraMoves: [{dx:1,dy:1},{dx:-1,dy:1}]
    },
    'pawn_spearman': {
        name: '–ö–æ–ø–µ–π—â–∏–∫', symbol: SYMBOLS.spearman, tier: 2, xpReq: 2,
        desc: '–ê—Ç–∞–∫—É–µ—Ç —á–µ—Ä–µ–∑ –∫–ª–µ—Ç–∫—É –≤–ø–µ—Ä–µ–¥',
        role: 'pawn', attackRange: 2
    },

    // –í–µ—Ç–∫–∞ –ö–æ–Ω—è
    'knight_camel': {
        name: '–í–µ—Ä–±–ª—é–¥', symbol: SYMBOLS.camel, tier: 2, xpReq: 2,
        desc: '–ü—Ä—ã–∂–æ–∫ "–ì" (3+1)',
        moves: MOVES_CAMEL, mode: 'leap'
    },
    'knight_paladin': {
        name: '–ü–∞–ª–∞–¥–∏–Ω', symbol: SYMBOLS.paladin, tier: 2, xpReq: 2,
        desc: '–ö–æ–Ω—å + –ö–æ—Ä–æ–ª—å',
        moves: getCombinedMoves(['knight', 'king']), mode: 'leap'
    },

    // –í–µ—Ç–∫–∞ –°–ª–æ–Ω–∞
    'bishop_bomber': {
        name: '–ë–æ–º–±–∞—Ä–¥–∏—Ä', symbol: SYMBOLS.bomber, tier: 2, xpReq: 2,
        desc: '–í–∑—Ä—ã–≤ 3x3 –ø—Ä–∏ –≤–∑—è—Ç–∏–∏',
        moves: getCombinedMoves(['bishop']), mode: 'slide', special: 'explode_3'
    },
    'bishop_ghost': {
        name: '–ü—Ä–∏–∑—Ä–∞–∫', symbol: SYMBOLS.ghost, tier: 2, xpReq: 2,
        desc: '–°–ª–æ–Ω, –ø—Ä—ã–≥–∞—é—â–∏–π —á–µ—Ä–µ–∑ —Ñ–∏–≥—É—Ä—ã',
        moves: getCombinedMoves(['bishop']), mode: 'leap_slide'
    },

    // –í–µ—Ç–∫–∞ –õ–∞–¥—å–∏
    'rook_tank': {
        name: '–¢–∞–Ω–∫', symbol: SYMBOLS.tank, tier: 2, xpReq: 2,
        desc: '–õ–∞–¥—å—è + –ö–æ—Ä–æ–ª—å',
        moves: getCombinedMoves(['rook', 'king']), mode: 'slide'
    },

    // === TIER 3 (LEGENDARY) ===
    
    // –ü–µ—à–∫–∞ -> –ö–æ–ø–µ–π—â–∏–∫ -> –°–ü–ê–†–¢–ê–ù–ï–¶
    'pawn_spartan': {
        name: '–°–ø–∞—Ä—Ç–∞–Ω–µ—Ü', symbol: SYMBOLS.spartan, tier: 3, xpReq: 999,
        desc: '–ê—Ç–∞–∫–∞ –¥–∞–ª—å–Ω–æ—Å—Ç—å—é 2 + –•–æ–¥–∏—Ç –∫–∞–∫ –ö–æ—Ä–æ–ª—å',
        moves: getCombinedMoves(['king']), mode: 'step', attackRange: 2, 
        special: 'range_capture'
    },
    // –ü–µ—à–∫–∞ -> –°–æ–ª–¥–∞—Ç -> –°–£–ü–ï–† –°–û–õ–î–ê–¢
    'pawn_supersoldier': {
        name: '–õ–µ–≥–∏–æ–Ω–µ—Ä', symbol: SYMBOLS.super_soldier, tier: 3, xpReq: 999,
        desc: '–•–æ–¥–∏—Ç –∏ –±—å–µ—Ç –Ω–∞ 2 –∫–ª–µ—Ç–∫–∏ –≤ –ª—é–±—É—é —Å—Ç–æ—Ä–æ–Ω—É',
        moves: [
            {dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1},{dx:1,dy:1},{dx:1,dy:-1},{dx:-1,dy:1},{dx:-1,dy:-1}, // 1 step
            {dx:2,dy:0},{dx:-2,dy:0},{dx:0,dy:2},{dx:0,dy:-2},{dx:2,dy:2},{dx:2,dy:-2},{dx:-2,dy:2},{dx:-2,dy:-2}  // 2 steps
        ], 
        mode: 'leap' 
    },

    // –ö–æ–Ω—å -> –í–µ—Ä–±–ª—é–¥ -> –ö–û–ù–ï-–í–ï–†–ë–õ–Æ–î
    'knight_camel_hybrid': {
        name: '–ö–æ–Ω–µ-–í–µ—Ä–±–ª—é–¥', symbol: SYMBOLS.camel_knight, tier: 3, xpReq: 999,
        desc: '–•–æ–¥–∏—Ç –∫–∞–∫ –ö–æ–Ω—å (2+1) –ò –í–µ—Ä–±–ª—é–¥ (3+1)',
        moves: [
            ...MOVES_KNIGHT,
            ...MOVES_CAMEL
        ],
        mode: 'leap'
    },
    // –ö–æ–Ω—å -> –ü–∞–ª–∞–¥–∏–Ω -> –•–†–ê–ú–û–í–ù–ò–ö
    'knight_crusader': {
        name: '–•—Ä–∞–º–æ–≤–Ω–∏–∫', symbol: SYMBOLS.crusader, tier: 3, xpReq: 999,
        desc: '–ö–æ–Ω—å + –°–ª–æ–Ω (–°–≤—è—Ç–æ–π –≤–æ–∏–Ω)',
        moves: getCombinedMoves(['knight', 'bishop']),
        mode: 'leap_slide_hybrid'
    },

    // –°–ª–æ–Ω -> –ë–æ–º–±–∞—Ä–¥–∏—Ä -> –Ø–î–ï–†–ù–´–ô –°–õ–û–ù
    'bishop_nuke': {
        name: '–Ø–¥–µ—Ä–Ω—ã–π –°–ª–æ–Ω', symbol: SYMBOLS.nuke_bishop, tier: 3, xpReq: 999,
        desc: '–¢–û–¢–ê–õ–¨–ù–´–ô –í–ó–†–´–í (5x5) –ø—Ä–∏ –≤–∑—è—Ç–∏–∏',
        moves: getCombinedMoves(['bishop']), mode: 'slide', special: 'explode_5'
    },
    // –°–ª–æ–Ω -> –ü—Ä–∏–∑—Ä–∞–∫ -> –°–ù–ê–ô–ü–ï–†
    'bishop_sniper': {
        name: '–°–Ω–∞–π–ø–µ—Ä', symbol: SYMBOLS.sniper, tier: 3, xpReq: 999,
        desc: '–°–ª–æ–Ω + –õ–∞–¥—å—è (–§–µ—Ä–∑—å), –ø—Ä—ã–≥–∞–µ—Ç —á–µ—Ä–µ–∑ –≤—Å–µ—Ö',
        moves: getCombinedMoves(['queen']), mode: 'leap_slide' 
    },

    // –õ–∞–¥—å—è -> –¢–∞–Ω–∫ -> –ö–†–ï–ü–û–°–¢–¨
    'rook_fortress': {
        name: '–ö—Ä–µ–ø–æ—Å—Ç—å', symbol: SYMBOLS.fortress, tier: 3, xpReq: 999,
        desc: '–õ–∞–¥—å—è + –ö–æ–Ω—å + –ö–æ—Ä–æ–ª—å (–¢–∞–Ω–∫ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª–∫–∞—Ö)',
        moves: getCombinedMoves(['rook', 'knight', 'king']), mode: 'leap_slide_hybrid'
    }
};

/**
 * –î–ï–†–ï–í–û –≠–í–û–õ–Æ–¶–ò–ò
 */
const EVOLUTION_TREE = {
    // TIER 1 -> TIER 2
    'pawn': ['pawn_soldier', 'pawn_spearman'],
    'knight': ['knight_camel', 'knight_paladin'],
    'bishop': ['bishop_bomber', 'bishop_ghost'],
    'rook': ['rook_tank'],
    'queen': [], 

    // TIER 2 -> TIER 3
    'pawn_soldier': ['pawn_supersoldier'],
    'pawn_spearman': ['pawn_spartan'],
    
    'knight_camel': ['knight_camel_hybrid'],
    'knight_paladin': ['knight_crusader'],

    'bishop_bomber': ['bishop_nuke'],
    'bishop_ghost': ['bishop_sniper'],

    'rook_tank': ['rook_fortress']
};

// –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
let board = [];
let currentTurn = 'white';
let selectedCell = null;
let possibleMoves = [];
let gameOver = false;

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

function initGame() {
    board = createBoard();
    currentTurn = 'white';
    selectedCell = null;
    gameOver = false;
    possibleMoves = [];
    document.getElementById('game-log').innerHTML = '';
    log('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! Tier 2 —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.');
    renderBoard();
    updateInfo();
}

function createBoard() {
    const newBoard = Array(8).fill(null).map(() => Array(8).fill(null));
    
    for(let x=0; x<8; x++) {
        newBoard[1][x] = createPiece('pawn', 'black');
        newBoard[6][x] = createPiece('pawn', 'white');
    }

    const backRow = ['rook', 'knight', 'bishop', 'queen', 'king', 'bishop', 'knight', 'rook'];
    backRow.forEach((type, x) => {
        newBoard[0][x] = createPiece(type, 'black');
        newBoard[7][x] = createPiece(type, 'white');
    });

    return newBoard;
}

function createPiece(type, color) {
    return {
        type: type,
        color: color,
        xp: 0,
        hasMoved: false,
        id: Math.random().toString(36).substr(2, 9)
    };
}

// --- –õ–æ–≥–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è ---

function getValidMoves(piece, startX, startY, checkBoard = board) {
    const moves = [];
    const def = PIECE_TYPES[piece.type];
    const isWhite = piece.color === 'white';
    const direction = isWhite ? -1 : 1;

    // 1. –õ–æ–≥–∏–∫–∞ –¥–ª—è "pawn" —Ä–æ–ª–∏ (–≤–∫–ª—é—á–∞—è –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ Tier 2 –ø–µ—à–∫–∏)
    if (def.role === 'pawn') {
        // –û–±—ã—á–Ω—ã–π —à–∞–≥
        let dy = direction;
        if (isValidPos(startX, startY + dy) && !checkBoard[startY + dy][startX]) {
            moves.push({x: startX, y: startY + dy});
            // Double move
            if (!piece.hasMoved && isValidPos(startX, startY + dy * 2) && !checkBoard[startY + dy * 2][startX]) {
                moves.push({x: startX, y: startY + dy * 2});
            }
        }

        // –ê—Ç–∞–∫–∞ –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–∞—è
        [[-1, dy], [1, dy]].forEach(att => {
            const tx = startX + att[0];
            const ty = startY + att[1];
            if (isValidPos(tx, ty)) {
                const target = checkBoard[ty][tx];
                if (target && target.color !== piece.color) {
                    moves.push({x: tx, y: ty, isCapture: true});
                }
            }
        });

        // Extra Moves (Soldier)
        if (def.extraMoves) {
            def.extraMoves.forEach(m => {
                // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Y –¥–ª—è –±–µ–ª—ã—Ö, –µ—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ "–≤–ø–µ—Ä–µ–¥"
                const actualDy = m.dy * direction; 
                const tx = startX + m.dx;
                const ty = startY + actualDy;
                if (isValidPos(tx, ty) && !checkBoard[ty][tx]) {
                    moves.push({x: tx, y: ty});
                }
            });
        }
        
        // Attack Range (Spearman / Spartan)
        // –î–ª—è –ø–µ—à–∫–∏ —ç—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥)
        if (def.attackRange && def.type !== 'pawn_spartan') { 
             const spearY = startY + (direction * def.attackRange);
             if (isValidPos(startX, spearY)) {
                 const target = checkBoard[spearY][startX];
                 if (target && target.color !== piece.color) {
                     // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è –¥–ª—è range 2
                     const midY = startY + direction;
                     if (!checkBoard[midY][startX]) {
                        moves.push({x: startX, y: spearY, isCapture: true});
                     }
                 }
             }
        }
    }

    // 2. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (Vectors)
    if (def.moves) {
        // Hybrid handling is tricky. 
        // –ï—Å–ª–∏ —ç—Ç–æ 'leap_slide_hybrid' (–•—Ä–∞–º–æ–≤–Ω–∏–∫, –ö—Ä–µ–ø–æ—Å—Ç—å), –Ω–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –≤–µ–∫—Ç–æ—Ä–∞ –ø—Ä—ã–≥–∞—é—Ç, –∞ –∫–∞–∫–∏–µ —Å–∫–æ–ª—å–∑—è—Ç.
        // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è V2: –µ—Å–ª–∏ mode 'leap_slide_hybrid', –º—ã —Å—á–∏—Ç–∞–µ–º –≤–µ–∫—Ç–æ—Ä–∞ > 2 –∏–ª–∏ —Ä—ã—Ü–∞—Ä—Å–∫–∏–µ –∫–∞–∫ leap, –∞ –ø—Ä—è–º—ã–µ 1 –∫–∞–∫ –Ω–∞—á–∞–ª–æ slide.
        // –ù–û: –ø—Ä–æ—â–µ –ø–µ—Ä–µ–±—Ä–∞—Ç—å –≤–µ–∫—Ç–æ—Ä—ã. –ï—Å–ª–∏ –≤–µ–∫—Ç–æ—Ä "–∫–æ—Ä–æ—Ç–∫–∏–π" (1) –∏ mode slide - —Å–ª–∞–π–¥–∏–º. –ï—Å–ª–∏ –≤–µ–∫—Ç–æ—Ä "–¥–ª–∏–Ω–Ω—ã–π" –∏–ª–∏ "–ì" - –ø—Ä—ã–≥–∞–µ–º.
        
        def.moves.forEach(vec => {
            let dx = vec.dx;
            let dy = vec.dy;
            
            const isKnightMove = Math.abs(dx) === 2 && Math.abs(dy) === 1 || Math.abs(dx) === 1 && Math.abs(dy) === 2;
            const isStep1 = Math.abs(dx) <= 1 && Math.abs(dy) <= 1;

            // –õ–æ–≥–∏–∫–∞ —Å–ª–∞–π–¥–∞ (–¥–ª—è –õ–∞–¥—å–∏, –°–ª–æ–Ω–∞, –§–µ—Ä–∑—è –∏ –≥–∏–±—Ä–∏–¥–æ–≤)
            if ((def.mode === 'slide' || def.mode === 'leap_slide' || def.mode === 'leap_slide_hybrid') && isStep1 && !isKnightMove) {
                // –≠—Ç–æ –Ω–∞—á–∞–ª–æ –ª—É—á–∞ —Å–ª–∞–π–¥–∞
                for (let i = 1; i < 8; i++) {
                    const tx = startX + (dx * i);
                    const ty = startY + (dy * i);
                    if (!isValidPos(tx, ty)) break;

                    const target = checkBoard[ty][tx];
                    if (!target) {
                        moves.push({x: tx, y: ty});
                    } else {
                        if (target.color !== piece.color) moves.push({x: tx, y: ty, isCapture: true});
                        // –ï—Å–ª–∏ mode === 'leap_slide' (–ü—Ä–∏–∑—Ä–∞–∫/–°–Ω–∞–π–ø–µ—Ä), –º—ã –ù–ï –ø—Ä–µ—Ä—ã–≤–∞–µ–º—Å—è –Ω–∞ —Ñ–∏–≥—É—Ä–∞—Ö!
                        if (def.mode !== 'leap_slide' && def.mode !== 'leap_slide_hybrid' && def.name !== '–°–Ω–∞–π–ø–µ—Ä') break;
                        // –°–Ω–∞–π–ø–µ—Ä –ø—Ä–æ—à–∏–≤–∞–µ—Ç –Ω–∞—Å–∫–≤–æ–∑—å? –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä—ã–≥–∞–µ—Ç?
                        // "leap_slide" usually means jumps over. –ù–æ capture –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ –≤ –∫–ª–∞—Å—Å–∏–∫–µ.
                        // –î–ª—è –ü—Ä–∏–∑—Ä–∞–∫–∞: –ø—Ä—ã–≥–∞–µ—Ç —á–µ—Ä–µ–∑ —Ñ–∏–≥—É—Ä—ã, –Ω–æ –≤–∑—è—Ç–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ (–≤—Å—Ç–∞–µ—Ç –Ω–∞ –º–µ—Å—Ç–æ –∂–µ—Ä—Ç–≤—ã).
                        break; 
                    }
                }
            } 
            // –õ–æ–≥–∏–∫–∞ –ø—Ä—ã–∂–∫–∞ (–ö–æ–Ω—å, –ö–æ—Ä–æ–ª—å, –í–µ—Ä–±–ª—é–¥)
            else {
                const tx = startX + dx;
                const ty = startY + dy;
                if (isValidPos(tx, ty)) {
                    const target = checkBoard[ty][tx];
                    if (!target || target.color !== piece.color) {
                        moves.push({x: tx, y: ty, isCapture: !!target});
                    }
                }
            }
        });
    }

    // 3. –°–ø–µ—Ü-–∞—Ç–∞–∫–∞ –°–ø–∞—Ä—Ç–∞–Ω—Ü–∞ (Range Attack 2 any direction)
    // –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ–¥—ã –∞—Ç–∞–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Ö–æ–¥–∞–º–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è, –µ—Å–ª–∏ —ç—Ç–æ Range Attack Unit –±–µ–∑ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è.
    // –ù–æ –≤ –Ω–∞—à–µ–º –¥–≤–∏–∂–∫–µ —Ö–æ–¥ = –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ.
    // –°–ø–∞—Ä—Ç–∞–Ω–µ—Ü: Moves like King (handled above). Attacks range 2.
    if (def.attackRange && def.type === 'pawn_spartan') {
        const ranges = [[0,2],[0,-2],[2,0],[-2,0],[2,2],[2,-2],[-2,2],[-2,-2]];
        ranges.forEach(r => {
             const tx = startX + r[0];
             const ty = startY + r[1];
             if(isValidPos(tx, ty)) {
                 const target = checkBoard[ty][tx];
                 if(target && target.color !== piece.color) {
                     // –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–∏—Å—Ç–æ—Ç—É –ª–∏–Ω–∏–∏ (–ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç)
                     const mx = startX + r[0]/2;
                     const my = startY + r[1]/2;
                     if (!checkBoard[my][mx]) {
                         moves.push({x: tx, y: ty, isCapture: true});
                     }
                 }
             }
        });
    }

    return moves;
}

function isValidPos(x, y) {
    return x >= 0 && x < 8 && y >= 0 && y < 8;
}

// --- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ ---

function cellClick(x, y) {
    if (gameOver) return;

    const clickedPiece = board[y][x];
    const move = possibleMoves.find(m => m.x === x && m.y === y);

    if (move) {
        makeMove(selectedCell.x, selectedCell.y, x, y);
        return;
    }

    if (clickedPiece && clickedPiece.color === currentTurn) {
        selectedCell = {x, y};
        possibleMoves = getValidMoves(clickedPiece, x, y);
        renderBoard();
        updateInfo(clickedPiece);
    } else {
        selectedCell = null;
        possibleMoves = [];
        renderBoard();
        updateInfo(null);
    }
}

function makeMove(fromX, fromY, toX, toY) {
    const piece = board[fromY][fromX];
    const target = board[toY][toX];
    
    let captureHappened = false;
    let enemyType = null;

    if (target) {
        captureHappened = true;
        enemyType = target.type;
        // XP System
        piece.xp += 1;
        
        if (target.type === 'king') {
            log(`üëë –ö–û–†–û–õ–¨ –£–ë–ò–¢! ${piece.color === 'white' ? '–ë–µ–ª—ã–µ' : '–ß–µ—Ä–Ω—ã–µ'} –ø–æ–±–µ–¥–∏–ª–∏!`);
            alert(`–ü–æ–±–µ–¥–∞!`);
            gameOver = true;
            board[toY][toX] = piece;
            board[fromY][fromX] = null;
            renderBoard();
            return;
        }
    }

    // Move
    board[toY][toX] = piece;
    board[fromY][fromX] = null;
    piece.hasMoved = true;

    // Log
    const def = PIECE_TYPES[piece.type];
    if (captureHappened) {
        log(`${def.symbol} ${def.name} —Ä—É–±–∏—Ç ${PIECE_TYPES[enemyType].name} (+1 XP)`);
    }

    // SPECIAL EFFECTS
    if (captureHappened && def.special) {
        if (def.special.startsWith('explode')) {
            const radius = def.special === 'explode_5' ? 2 : 1; // 5x5 is radius 2, 3x3 is radius 1
            explode(toX, toY, piece.color, radius);
        }
    }

    // EVOLUTION CHECK
    if (canEvolve(piece)) {
        renderBoard();
        showEvolutionModal(piece, toX, toY);
        return; 
    }

    endTurn();
}

function endTurn() {
    selectedCell = null;
    possibleMoves = [];
    currentTurn = currentTurn === 'white' ? 'black' : 'white';
    renderBoard();
    
    const turnText = document.getElementById('turn-display');
    turnText.innerText = `–•–æ–¥: ${currentTurn === 'white' ? '–ë–µ–ª—ã–µ' : '–ß–µ—Ä–Ω—ã–µ'}`;
    turnText.style.color = currentTurn === 'white' ? '#fff' : '#aaa';
}

function explode(cx, cy, attackerColor, radius) {
    log(`üí• –ú–û–©–ù–´–ô –í–ó–†–´–í (–†–∞–¥–∏—É—Å ${radius})!`);
    for (let dy = -radius; dy <= radius; dy++) {
        for (let dx = -radius; dx <= radius; dx++) {
            if (dx===0 && dy===0) continue;
            const tx = cx + dx;
            const ty = cy + dy;
            if (isValidPos(tx, ty)) {
                const victim = board[ty][tx];
                if (victim && victim.type !== 'king') { // King immune to explosion for gameplay sanity
                    // Friendly fire? Let's say yes for Nuke, no for Bomber.
                    // For logic simplicity: Nuke kills everyone. Bomber kills enemies.
                    const isNuke = radius > 1;
                    if (isNuke || victim.color !== attackerColor) {
                        log(`–í–∑—Ä—ã–≤ —É–Ω–∏—á—Ç–æ–∂–∏–ª ${PIECE_TYPES[victim.type].name}`);
                        board[ty][tx] = null;
                        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç —á–∞—Å—Ç–∏—Ü –≤ –±—É–¥—É—â–µ–º
                    }
                }
            }
        }
    }
}

// --- –≠–≤–æ–ª—é—Ü–∏—è ---

function canEvolve(piece) {
    const evolutions = EVOLUTION_TREE[piece.type];
    if (!evolutions || evolutions.length === 0) return false;
    
    const def = PIECE_TYPES[piece.type];
    return piece.xp >= def.xpReq;
}

function showEvolutionModal(piece) {
    const modal = document.getElementById('evolution-modal');
    const container = document.getElementById('evo-container');
    const title = document.getElementById('evo-title');
    
    title.innerText = `${PIECE_TYPES[piece.type].name} –º—É—Ç–∏—Ä—É–µ—Ç (Tier ${PIECE_TYPES[piece.type].tier} -> ${PIECE_TYPES[piece.type].tier + 1})!`;
    container.innerHTML = '';

    const options = EVOLUTION_TREE[piece.type];
    
    options.forEach(evoType => {
        const evoDef = PIECE_TYPES[evoType];
        
        const card = document.createElement('div');
        card.className = `evo-card ${evoDef.tier === 3 ? 'tier-3-card' : ''}`;
        card.innerHTML = `
            <div class="evo-tier">T${evoDef.tier}</div>
            <span class="evo-icon">${evoDef.symbol}</span>
            <span class="evo-name">${evoDef.name}</span>
            <span class="evo-desc">${evoDef.desc || ''}</span>
        `;
        
        card.onclick = () => {
            performEvolution(piece, evoType);
            modal.style.display = 'none';
        };
        
        container.appendChild(card);
    });

    modal.style.display = 'flex';
}

function performEvolution(piece, newType) {
    const oldName = PIECE_TYPES[piece.type].name;
    piece.type = newType;
    piece.xp = 0; // –°–±—Ä–æ—Å XP
    const newDef = PIECE_TYPES[newType];
    
    log(`üß¨ –ú–£–¢–ê–¶–ò–Ø: ${oldName} –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –≤ ${newDef.name}!`);
    endTurn();
}

// --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ ---

function renderBoard() {
    const boardEl = document.getElementById('board');
    boardEl.innerHTML = '';

    for (let y = 0; y < 8; y++) {
        for (let x = 0; x < 8; x++) {
            const cell = document.createElement('div');
            cell.className = `cell ${(x + y) % 2 === 0 ? 'light' : 'dark'}`;
            cell.onclick = () => cellClick(x, y);

            // Highlights
            const isPossible = possibleMoves.some(m => m.x === x && m.y === y);
            if (isPossible) {
                cell.classList.add('possible-move');
                if (board[y][x]) cell.classList.add('capture');
            }
            if (selectedCell && selectedCell.x === x && selectedCell.y === y) {
                cell.classList.add('selected');
            }

            // Render Piece
            const piece = board[y][x];
            if (piece) {
                const pieceEl = document.createElement('div');
                const def = PIECE_TYPES[piece.type];
                pieceEl.className = `piece ${piece.color} tier-${def.tier}`;
                pieceEl.innerText = def.symbol;
                
                if (piece.xp > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'lvl-badge';
                    // Show progress like "1/2"
                    badge.innerText = `${piece.xp}/${def.xpReq}`;
                    pieceEl.appendChild(badge);
                }
                
                cell.appendChild(pieceEl);
            }
            boardEl.appendChild(cell);
        }
    }
}

function updateInfo(piece) {
    const infoPanel = document.getElementById('piece-info');
    if (!piece) {
        infoPanel.innerText = "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ñ–∏–≥—É—Ä—É –¥–ª—è –∏–Ω—Ñ–æ...";
        return;
    }

    const def = PIECE_TYPES[piece.type];
    const nextEvos = EVOLUTION_TREE[piece.type] || [];
    const hasEvo = nextEvos.length > 0;
    
    infoPanel.innerHTML = `
        <div style="font-size: 1.4em; margin-bottom:5px;">${def.symbol} <strong>${def.name}</strong> <span style="font-size:0.6em; background:#f1c40f; color:#000; padding:2px 5px; border-radius:4px;">Tier ${def.tier}</span></div>
        <div style="font-size: 0.9em; color: #ccc; margin-bottom: 10px;">${def.desc || ''}</div>
        
        ${hasEvo ? 
            `–ü—Ä–æ–≥—Ä–µ—Å—Å: <b>${piece.xp} / ${def.xpReq}</b> XP<br>
            <small style="color:#aaa">–°–ª–µ–¥—É—é—â–∞—è —Å—Ç–∞–¥–∏—è: ${nextEvos.map(t => PIECE_TYPES[t].name).join(' –∏–ª–∏ ')}</small>` 
            : 
            `<b style="color:#f1c40f">–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –£–†–û–í–ï–ù–¨</b>`
        }
    `;
}

function log(msg) {
    const logEl = document.getElementById('game-log');
    const entry = document.createElement('div');
    entry.innerHTML = `> ${msg}`;
    entry.style.padding = "2px 0";
    entry.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
    logEl.prepend(entry); // Newest at top
}

// Start
initGame();

</script>
</body>
</html>